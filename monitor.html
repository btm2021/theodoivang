<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Monitor Giá Vàng</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="gold-utils.js"></script>
  <style>
    /* Loading overlay */
    .loading-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(255, 255, 255, 0.9);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .loading-overlay.show { display: flex; }
    .loading-spinner {
      width: 40px; height: 40px;
      border: 4px solid #e5e7eb;
      border-top-color: #3b82f6;
      border-radius: 9999px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .collapse-button svg {
      transition: transform 0.2s ease-in-out;
    }
    .collapse-button.expanded svg {
      transform: rotate(180deg);
    }
  </style>
</head>

<body class="bg-white min-h-screen">
  <!-- Header -->
  

  <!-- Main -->
  <main class="w-full max-w-screen-2xl mx-auto px-4 py-4">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <!-- Internal Prices -->
      <section class="lg:col-span-2 bg-white border border-gray-200 rounded">
        <div class="px-4 py-2 border-b border-gray-200 bg-gray-50">
          <h2 class="text-sm font-semibold text-gray-700">Giá nội bộ</h2>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="bg-gray-100 text-gray-600 text-xs uppercase">
              <tr>
                <th class="px-3 py-2 text-left">Loại</th>
                <th class="px-3 py-2 text-left">Tuổi</th>
                <th class="px-3 py-2 text-left">Mua</th>
                <th class="px-3 py-2 text-left">Bán</th>
                <th class="px-3 py-2 text-left">Chênh (Triệu/Lượng)</th>
                <th class="px-3 py-2 text-center">Chi tiết</th>
              </tr>
            </thead>
            <tbody id="internalTableBody" class="divide-y divide-gray-100">
              <tr>
                <td colspan="5" class="px-3 py-4 text-center text-gray-500">Đang tải...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- Public Prices -->
      <div class="lg:col-span-1 flex flex-col gap-4">
        <section class="bg-white border border-gray-200 rounded">
          <div class="px-4 py-2 border-b border-gray-200 bg-gray-50">
            <h2 class="text-sm font-semibold text-gray-700">Giá công khai (Webgia)</h2>
          </div>
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
              <thead class="bg-gray-100 text-gray-600 text-xs uppercase">
                <tr>
                  <th class="px-3 py-2 text-left">Loại</th>
                  <th class="px-3 py-2 text-left">Tuổi</th>
                  <th class="px-3 py-2 text-left">Mua</th>
                  <th class="px-3 py-2 text-left">Bán</th>
                </tr>
              </thead>
              <tbody id="publicTableBody" class="divide-y divide-gray-100">
                <tr>
                  <td colspan="4" class="px-3 py-4 text-center text-gray-500">Đang tải...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>

        <!-- Quick Calculator -->
        <section id="quickCalcSection" class="bg-white border border-gray-200 rounded" style="display: none;">
          <div class="px-4 py-2 border-b border-gray-200 bg-gray-50">
            <h2 class="text-sm font-semibold text-gray-700">Tính nhanh</h2>
          </div>
          <div class="p-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
              <div class="col-span-1">
                <label for="goldTypeSelect" class="block text-xs font-medium text-gray-600 mb-1">Loại vàng</label>
                <select id="goldTypeSelect" class="w-full text-sm border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"></select>
              </div>
              <div class="col-span-1">
                <label for="goldWeightInput" class="block text-xs font-medium text-gray-600 mb-1">Trọng lượng (chỉ)</label>
                <input type="number" id="goldWeightInput" placeholder="VD: 1.5" class="w-full text-sm border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
              </div>
              <div class="col-span-1">
                <button id="calculateBtn" class="w-full bg-blue-600 text-white text-sm font-semibold py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Tính toán</button>
              </div>
            </div>
            <div id="quickCalcResult" class="mt-4 text-sm"></div>
          </div>
        </section>
      </div>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="loading-overlay">
    <div class="text-center">
      <div class="loading-spinner mx-auto mb-3"></div>
      <div class="text-gray-600 text-sm font-medium">Đang tải dữ liệu...</div>
    </div>
  </div>

  <script>
    // API config
    const urlParams = new URLSearchParams(window.location.search);
    const supabaseUrl = urlParams.get('url');
    const token = urlParams.get('header');
    const webgiaUrl = urlParams.get('webgia') || 'https://cors.trinhminhbao.workers.dev/?url=https://webgia.com/gia-vang/mi-hong/';

    const API_CONFIG = {
      supabase: {
        url: supabaseUrl,
        headers: {
          'apikey': token,
          'Authorization': `Bearer ${token}`
        }
      },
      webgia: webgiaUrl
    };

    let internalData = [];
    let publicData = [];
    let goldUtils = null;

    // Status UI
    function updateStatus(message, type) {
      // const el = document.getElementById('statusIndicator');
      // const color = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-yellow-400';
      // el.innerHTML = `<span class="inline-block w-2 h-2 rounded-full ${color}"></span><span class="text-xs text-gray-600">${message}</span>`;
    }

    function showLoadingOverlay() { document.getElementById('loadingOverlay').classList.add('show'); }
    function hideLoadingOverlay() { document.getElementById('loadingOverlay').classList.remove('show'); }

    // Init GoldUtils
    function initGoldUtils() {
      if (window.GoldUtils) { goldUtils = window.GoldUtils; return true; }
      return false;
    }

    // Fetch internal data (Supabase)
    async function fetchInternalData() {
      try {
        const res = await fetch(API_CONFIG.supabase.url, { headers: API_CONFIG.supabase.headers });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        // Small normalization
        internalData = (data || []).map((item, index) => ({
          ...item,
          id: `internal-item-${index}`,
          code: item.code === '9999' ? '995' : (item.code || item.age || null),
        }));

        const gold610 = internalData.find(item => item.code === '610');
        if (gold610) {
          internalData.push({
            id: 'internal-item-doi-610',
            code: '610',
            age: '610',
            hienthi:'610 Đổi 100k',
            buyingPrice: (Number(gold610.sellingPrice) || 0) - 100,
            sellingPrice: (Number(gold610.sellingPrice) || 0) - 100,
          });
        }

        const gold710 = internalData.find(item => item.code === '710');
        if (gold710) {
          internalData.push({
            id: 'internal-item-doi-710',
            code: '710',
            age: '710',
            hienthi:'710 Đổi 100k',
            buyingPrice: (Number(gold710.sellingPrice) || 0) - 100,
            sellingPrice: (Number(gold710.sellingPrice) || 0) - 100,
          });
        }

        const gold980 = internalData.find(item => item.code === '980');
        if (gold980) {
          internalData.push({
            id: 'internal-item-doi-980',
            code: '980',
            age: '980',
            hienthi:'980 Đổi 100k',
            buyingPrice: (Number(gold980.sellingPrice) || 0) - 100,
            sellingPrice: (Number(gold980.sellingPrice) || 0) - 100,
          });
        }
        console.log(internalData)
        renderInternalTable();
        renderQuickCalcForm();
        return true;
      } catch (e) {
        console.error('Lỗi khi tải dữ liệu nội bộ:', e);
        document.getElementById('internalTableBody').innerHTML = '<tr><td colspan="5" class="px-3 py-4 text-center text-red-600">Không tải được dữ liệu</td></tr>';
        return false;
      }
    }

    // Fetch public data (webgia)
    async function fetchPublicData() {
      try {
        const res = await fetch(API_CONFIG.webgia);
        const html = await res.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const table = doc.querySelector('table.table-radius.table-hover');
        if (!table) throw new Error('Không tìm thấy bảng giá');

        const rows = table.querySelectorAll('tbody tr');
        const out = [];
        rows.forEach((row) => {
          const nameCell = row.querySelector('th');
          const cells = row.querySelectorAll('td');
          if (!nameCell || cells.length < 2) return;

          const name = nameCell.textContent.trim();
          // Buy
          let buyPrice = 0, sellPrice = 0, hasPrice = false;
          const buyCell = cells[0];
          const buyText = buyCell.textContent.trim();
          if (buyCell.classList.contains('text-right') && !buyCell.hasAttribute('nb')) {
            const n = parseFloat(buyText.replace(/[^\d]/g, ''));
            if (!Number.isNaN(n) && n > 0) { buyPrice = n; hasPrice = true; }
          } else if (buyCell.hasAttribute('nb')) {
            const decoded = goldUtils.decodePrice(buyCell.getAttribute('nb'));
            if (decoded > 0) { buyPrice = decoded; hasPrice = true; }
          } else if (buyText !== '-') {
            const n = parseFloat(buyText.replace(/[^\d]/g, ''));
            if (!Number.isNaN(n) && n > 0) { buyPrice = n; hasPrice = true; }
          }

          // Sell
          const sellCell = cells[1];
          const sellText = sellCell.textContent.trim();
          if (sellCell.classList.contains('text-right') && !sellCell.hasAttribute('nb')) {
            const n = parseFloat(sellText.replace(/[^\d]/g, ''));
            if (!Number.isNaN(n) && n > 0) { sellPrice = n; hasPrice = true; }
          } else if (sellCell.hasAttribute('nb')) {
            const decoded = goldUtils.decodePrice(sellCell.getAttribute('nb'));
            if (decoded > 0) { sellPrice = decoded; hasPrice = true; }
          } else if (sellText !== '-') {
            const n = parseFloat(sellText.replace(/[^\d]/g, ''));
            if (!Number.isNaN(n) && n > 0) { sellPrice = n; hasPrice = true; }
          }

          out.push({
            name,
            age: goldUtils.extractAge(name),
            buyPrice,
            sellPrice,
            hasPrice,
          });
        });

        publicData = out;
        renderPublicTable();
        // Re-render internal for updated chênh lệch
        renderInternalTable();
        return true;
      } catch (e) {
        console.error('Lỗi khi tải dữ liệu công khai:', e);
        document.getElementById('publicTableBody').innerHTML = '<tr><td colspan="4" class="px-3 py-4 text-center text-red-600">Không tải được dữ liệu</td></tr>';
        // If public fails, re-render internal without chênh
        renderInternalTable();
        return false;
      }
    }

    function getGold950FromPublic() {
      return publicData.find((x) => Number(x.age) === 950 && Number(x.buyPrice) > 0) || null;
    }

    function calculateItemProfit(item) {
      const gold950 = getGold950FromPublic();
      if (!gold950) return { profit: 0, profitText: '-', cls: '' };
      const displayAge = item.code || item.age || 610;
      const actualAge = goldUtils.getActualGoldAge(displayAge);
      const internalBuy = (Number(item.buyingPrice ?? item.buyPrice) || 0) * 1000;
      if (internalBuy === 0) return { profit: 0, profitText: '-', cls: '' };

      const originalWeight = 10; // 1 lượng = 10 chỉ
      const originalValue = originalWeight * internalBuy;
      let convertedValue = 0;
      if (actualAge === 950) {
        convertedValue = originalWeight * gold950.buyPrice;
      } else {
        const convertedWeight = goldUtils.convertWeight(originalWeight, actualAge, 950);
        convertedValue = convertedWeight * gold950.buyPrice;
      }
      const diff = convertedValue - originalValue;
      const pct = goldUtils.calculatePercentageDiff(convertedValue, originalValue);
      const text = `${diff >= 0 ? '+' : ''}${goldUtils.formatMoney(Math.abs(diff))} (${diff >= 0 ? '+' : ''}${pct.toFixed(1)}%)`;
      return { profit: diff, profitText: text, cls: diff >= 0 ? 'text-green-600' : 'text-red-600' };
    }

    function renderInternalTable() {
      const tbody = document.getElementById('internalTableBody');
      if (!Array.isArray(internalData) || internalData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="px-3 py-4 text-center text-gray-500">Không có dữ liệu</td></tr>';
        return;
      }
      let html = '';
      internalData.forEach(item => {
        const { profitText, cls } = calculateItemProfit(item);
        const buy = goldUtils.formatMoney((Number(item.buyingPrice ?? item.buyPrice) || 0) * 1000);
        const sell = goldUtils.formatMoney((Number(item.sellingPrice ?? item.sellPrice) || 0) * 1000);

        html += `
          <tr id="${item.id}" class="hover:bg-gray-50">
            <td class="px-3 py-2 text-xs font-medium text-gray-900">Vàng ${item.hienthi || ''}</td>
            <td class="px-3 py-2 text-xs text-gray-500">${item.code || item.age || 'N/A'}</td>
            <td class="px-3 py-2 text-xs font-semibold text-blue-600">${buy}</td>
            <td class="px-3 py-2 text-xs font-semibold text-blue-600">${sell}</td>
            <td class="px-3 py-2 text-xs font-semibold ${cls}">${profitText}</td>
            <td class="px-3 py-2 text-center">
              <button class="collapse-button p-1 rounded-full hover:bg-gray-200" data-target="#detail-${item.id}">
                <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
              </button>
            </td>
          </tr>
          <tr id="detail-${item.id}" class="bg-gray-50 hidden">
             <td colspan="6" class="p-0">${renderDetailedComparison(item)}</td>
          </tr>
        `;
      });
      tbody.innerHTML = html;
    }

    function renderPublicTable() {
      const tbody = document.getElementById('publicTableBody');
      if (!Array.isArray(publicData) || publicData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="px-3 py-4 text-center text-gray-500">Không có dữ liệu</td></tr>';
        return;
      }
      tbody.innerHTML = publicData.map((item) => `
        <tr class="hover:bg-gray-50">
          <td class="px-3 py-2 text-xs font-medium text-gray-900">${item.name}</td>
          <td class="px-3 py-2 text-xs text-gray-500">${item.age}</td>
          <td class="px-3 py-2 text-xs font-semibold text-blue-600">${goldUtils.formatMoney(item.buyPrice)}</td>
          <td class="px-3 py-2 text-xs font-semibold text-blue-600">${goldUtils.formatMoney(item.sellPrice)}</td>
        </tr>`).join('');
    }

    function renderDetailedComparison(item) {
      const gold950 = getGold950FromPublic();
      if (!item || !gold950) return '';

      const displayAge = item.code || item.age || 610;
      const actualAge = goldUtils.getActualGoldAge(displayAge);
      const internalBuy = (Number(item.buyingPrice ?? item.buyPrice) || 0) * 1000;
      
      const originalWeight = 10; // 10 chỉ
      const convertedWeight = goldUtils.convertWeight(originalWeight, actualAge, 950);
      const originalValue = originalWeight * internalBuy;
      const convertedValue = convertedWeight * gold950.buyPrice;
      const diff = convertedValue - originalValue;
      const cls = diff >= 0 ? 'text-green-600' : 'text-red-600';
      const hienthi = item.hienthi ? ` (${item.hienthi})` : '';
      return `
        <div class="p-2 text-xs">
          <div class="grid grid-cols-2 gap-2">
            <div>
              <div class="font-semibold">Tính toán chi tiết:</div>
              <div>- Tuổi vàng hiển thị: <span class="font-mono">${hienthi}</span></div>
              <div>- Tuổi vàng thực tế để quy đổi: <span class="font-mono">${actualAge}</span></div>
              <div>- Giá vàng 950 (mua vào): <span class="font-mono">${goldUtils.formatMoney(gold950.buyPrice)}</span></div>
            </div>
            <div>
              <div class="font-semibold">Công thức:</div>
              <div>- Trọng lượng sau quy đổi = <span class="font-mono">(${originalWeight} * ${actualAge}) / 950 = ${goldUtils.formatWeight(convertedWeight)}</span></div>
              <div>- Giá trị sau quy đổi = <span class="font-mono">${goldUtils.formatWeight(convertedWeight)} * ${goldUtils.formatMoney(gold950.buyPrice)} = ${goldUtils.formatMoney(convertedValue)}</span></div>
              <div>- Chênh lệch = <span class="font-mono">${goldUtils.formatMoney(convertedValue)} - ${goldUtils.formatMoney(originalValue)} = <span class="font-semibold ${cls}">${diff >= 0 ? '+' : ''}${goldUtils.formatMoney(diff)}</span></span></div>
            </div>
          </div>
        </div>
      `;
    }

    

    function renderQuickCalcForm() {
      const select = document.getElementById('goldTypeSelect');
      if (!select || !Array.isArray(internalData) || internalData.length === 0) {
        document.getElementById('quickCalcSection').style.display = 'none';
        return;
      }
      
      let optionsHtml = '<option value="">-- Chọn loại vàng --</option>';
      internalData.forEach(item => {
        optionsHtml += `<option value="${item.id}">Vàng ${item.hienthi || ''}</option>`;
      });
      select.innerHTML = optionsHtml;
      document.getElementById('quickCalcSection').style.display = 'block';
    }

    function calculateAndDisplayQuickResult() {
      const resultDiv = document.getElementById('quickCalcResult');
      const selectedId = document.getElementById('goldTypeSelect').value;
      const weightInput = document.getElementById('goldWeightInput').value;
      
      const originalWeight = parseFloat(weightInput);
      if (!selectedId || !originalWeight || originalWeight <= 0) {
        resultDiv.innerHTML = '<p class="text-red-600">Vui lòng chọn loại vàng và nhập trọng lượng hợp lệ.</p>';
        return;
      }
      
      const item = internalData.find(i => i.id === selectedId);
      const gold950 = getGold950FromPublic();
      
      if (!item || !gold950) {
        resultDiv.innerHTML = '<p class="text-red-600">Không có đủ dữ liệu để tính toán.</p>';
        return;
      }
      
      const displayAge = item.code || item.age || 610;
      const actualAge = goldUtils.getActualGoldAge(displayAge);
      const internalBuy = (Number(item.buyingPrice ?? item.buyPrice) || 0) * 1000;
      
      const convertedWeight = goldUtils.convertWeight(originalWeight, actualAge, 950);
      const originalValue = originalWeight * internalBuy;
      const convertedValue = convertedWeight * gold950.buyPrice;
      const diff = convertedValue - originalValue;
      const cls = diff >= 0 ? 'text-green-600' : 'text-red-600';
      const hienthi = item.hienthi ? ` (${item.hienthi})` : '';

      resultDiv.innerHTML = `
        <div class="p-2 text-xs border rounded border-gray-200 bg-gray-50">
          <div class="grid grid-cols-2 gap-2">
            <div>
              <div class="font-semibold">Tính toán chi tiết cho ${goldUtils.formatWeight(originalWeight)} vàng${hienthi}:</div>
              <div>- Tuổi vàng thực tế: <span class="font-mono">${actualAge}</span></div>
              <div>- Giá mua nội bộ (1 chỉ): <span class="font-mono">${goldUtils.formatMoney(internalBuy)}</span></div>
              <div>- Giá vàng 950 (mua vào): <span class="font-mono">${goldUtils.formatMoney(gold950.buyPrice)}</span></div>
            </div>
            <div>
              <div class="font-semibold">Công thức:</div>
              <div>- Trọng lượng sau quy đổi = <span class="font-mono">(${originalWeight} * ${actualAge}) / 950 = ${goldUtils.formatWeight(convertedWeight)}</span></div>
              <div>- Giá trị sau quy đổi = <span class="font-mono">${goldUtils.formatWeight(convertedWeight)} * ${goldUtils.formatMoney(gold950.buyPrice)} = ${goldUtils.formatMoney(convertedValue)}</span></div>
              <div>- Chênh lệch = <span class="font-mono">${goldUtils.formatMoney(convertedValue)} - ${goldUtils.formatMoney(originalValue)} = <span class="font-semibold ${cls}">${diff >= 0 ? '+' : ''}${goldUtils.formatMoney(diff)}</span></span></div>
            </div>
          </div>
        </div>
      `;
    }

    async function loadAllData() {
      showLoadingOverlay();
      updateStatus('Đang tải...', 'loading');
      const [ok1, ok2] = await Promise.all([fetchInternalData(), fetchPublicData()]);
      hideLoadingOverlay();
      if (ok1 && ok2) updateStatus('Đã cập nhật', 'success');
      else if (ok1 || ok2) updateStatus('Đã cập nhật một phần', 'success');
      else updateStatus('Lỗi tải dữ liệu', 'error');
    }

    document.addEventListener('DOMContentLoaded', () => {
      if (!initGoldUtils()) {
        console.error('GoldUtils chưa sẵn sàng');
        updateStatus('Lỗi: không khởi tạo được', 'error');
        return;
      }
      loadAllData();
      document.getElementById('calculateBtn').addEventListener('click', calculateAndDisplayQuickResult);
      const internalTableBody = document.getElementById('internalTableBody');
      internalTableBody.addEventListener('click', (e) => {
        const button = e.target.closest('.collapse-button');
        if (button) {
          const targetId = button.dataset.target;
          const targetElement = document.querySelector(targetId);
          if (targetElement) {
            targetElement.classList.toggle('hidden');
            button.classList.toggle('expanded');
          }
        }
      });
      setInterval(loadAllData, 5 * 60 * 1000);
    });
  </script>
</body>

</html>