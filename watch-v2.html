<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watch V2 - Pricing Engine</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-vue@2.23.1/dist/bootstrap-vue.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/vue@2.7.14/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-vue@2.23.1/dist/bootstrap-vue.min.js"></script>
    <style>
        [v-cloak] {
            display: none;
        }

        .price-positive {
            color: #28a745;
            font-weight: bold;
        }

        .price-negative {
            color: #dc3545;
            font-weight: bold;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div id="app" v-cloak>
        <b-container fluid class="py-4">
          

            <div v-if="isLoading && !internalData.length" class="text-center">
                <div class="loading-spinner"></div>
                <p class="text-muted">ƒêang t·∫£i d·ªØ li·ªáu...</p>
            </div>

            <b-row v-else>
                <b-col lg="6" class="mb-4">
                    <b-card header="Gi√° n·ªôi b·ªô" header-bg-variant="primary" header-text-variant="white">
                        <b-table :items="internalData" :fields="internalFields" striped hover responsive small>
                            <template #cell(name)="data">
                                <strong>V√†ng {{ data.item.hienthi }}</strong>
                            </template>
                            <template #cell(buyingPrice)="data">
                                <span class="text-primary font-weight-bold">
                                    {{ formatPrice(data.item.buyingPrice) }}
                                </span>
                            </template>
                            <template #cell(sellingPrice)="data">
                                <span class="text-primary font-weight-bold">
                                    {{ formatPrice(data.item.sellingPrice) }}
                                </span>
                            </template>
                            <template #cell(buyDiff)="data">
                                <span :class="getDiffClass(data.item.buyProfit)">
                                    {{ data.item.buyDiffText }}
                                </span>
                            </template>
                        </b-table>
                    </b-card>
                </b-col>

                <b-col lg="6">
                    <!-- G·ª£i √Ω gi√° 610 -->
                    <b-card v-if="suggestion610" header="üéØ G·ª£i √Ω gi√° 610" header-bg-variant="warning"
                        header-text-variant="dark" class="mb-3">

                        <b-row class="text-center mb-3">
                            <b-col cols="6">
                                <div class="text-muted small">Gi√° MUA</div>
                                <h4 class="text-success mb-0">{{ formatPrice(suggestion610.suggestedBuyPrice / 1000) }}
                                </h4>
                            </b-col>
                            <b-col cols="6">
                                <div class="text-muted small">Gi√° B√ÅN</div>
                                <h4 class="text-danger mb-0">{{ formatPrice(suggestion610.suggestedSellPrice / 1000) }}
                                </h4>
                            </b-col>
                        </b-row>

                        <hr class="my-2">

                        <div class="small">

                            <b-row class="mb-1">
                                <b-col cols="7" class="text-muted">Gi√° L·ªách so v·ªõi 950:</b-col>
                                <b-col cols="5" class="text-right"  class="text-success">
                                    <strong class="text-success">+{{
                                        formatPriceRaw(suggestion610.buyMargin) }}</strong>
                                </b-col>
                            </b-row>
                        </div>

                        <hr class="my-2">

                        <div class="small">
                            <strong>üí° Gi·∫£i th√≠ch:</strong>
                            <ul class="mb-2 pl-3" style="font-size: 0.85rem;">
                                <li>Mua 1 l∆∞·ª£ng 610: <strong>{{ formatPriceRaw(suggestion610.costAt610) }}</strong></li>
                                <li class="text-muted">
                                    <small>(V√†ng 610 th·ª±c t·∫ø ch·ªâ c√≥ ƒë·ªô tinh khi·∫øt {{ suggestion610.actualAge }})</small>
                                </li>
                                <li>Quy ƒë·ªïi 600‚Üí950: <strong>{{ suggestion610.convertedWeight }} ch·ªâ</strong>
                                  <li class="text-muted">
                                    <small>(ƒê√£ tr·ª´ hao 20 v√†o tu·ªïi)</small>
                                </li>
                                </li>
                                <li>B√°n 950 ƒë∆∞·ª£c: <strong>{{ formatPriceRaw(suggestion610.valueAt950) }}</strong></li>
                                <li>Ch√™nh l·ªách: <strong :class="getMarginClass(suggestion610.buyMargin)">{{
                                        formatPriceRaw(suggestion610.buyMargin) }}</strong></li>
                            </ul>
                        </div>

                        <div class="small text-center">
                            <b-badge :variant="getSafetyVariant(suggestion610.safetyStatus)">
                                {{ suggestion610.safetyStatus }}
                            </b-badge>
                            <b-badge variant="secondary" class="ml-1">
                                Score: {{ suggestion610.totalScore }}
                            </b-badge>
                        </div>
                    </b-card>

                    <!-- Public Prices -->
                 
                </b-col>
                <b-col lg="6">
                    <b-card header="Gi√° c√¥ng khai (Webgia)" header-bg-variant="success" header-text-variant="white">
                        <b-table :items="publicData" :fields="publicFields" striped hover responsive small>
                            <template #cell(buyPrice)="data">
                                <span class="text-success font-weight-bold">
                                    {{ formatPrice(data.item.buyPrice / 1000) }}
                                </span>
                            </template>
                            <template #cell(sellPrice)="data">
                                <span class="text-success font-weight-bold">
                                    {{ formatPrice(data.item.sellPrice / 1000) }}
                                </span>
                            </template>
                        </b-table>
                    </b-card>
                </b-col>
            </b-row>
        </b-container>
    </div>

    <script src="gold-utils.js"></script>
    <script src="pricing-engine.js"></script>
    <script>
        // Wait for DOM and scripts to be fully loaded
        document.addEventListener('DOMContentLoaded', function () {
            // Debug: Check if utilities are loaded
            console.log('GoldUtils loaded:', typeof window.GoldUtils);
            console.log('PricingEngine loaded:', typeof window.PricingEngine);

            if (typeof window.GoldUtils === 'undefined') {
                console.error('ERROR: gold-utils.js not loaded properly!');
                alert('Error: gold-utils.js not loaded. Please check file path.');
                return;
            }
            if (typeof window.PricingEngine === 'undefined') {
                console.error('ERROR: pricing-engine.js not loaded properly!');
                alert('Error: pricing-engine.js not loaded. Please check file path.');
                return;
            }

            initVueApp();
        });

        function initVueApp() {
            new Vue({
                el: '#app',
                data() {
                    return {
                        isLoading: false,
                        lastUpdate: '',
                        internalData: [],
                        publicData: [],
                        gold950BuyPrice: 0,
                        suggestion610: null,
                        suggestion610V2: null,
                        recentGold950Prices: [],
                        internalFields: [
                            { key: 'name', label: 'Lo·∫°i', sortable: true },
                            { key: 'code', label: 'Tu·ªïi', sortable: true },
                            { key: 'buyingPrice', label: 'Mua', sortable: true },
                            { key: 'sellingPrice', label: 'B√°n', sortable: true },
                            { key: 'buyDiff', label: 'Ch√™nh Mua (Tri·ªáu/L∆∞·ª£ng)', sortable: true }
                        ],
                        publicFields: [
                            { key: 'name', label: 'Lo·∫°i', sortable: true },
                            { key: 'age', label: 'Tu·ªïi', sortable: true },
                            { key: 'buyPrice', label: 'Mua', sortable: true },
                            { key: 'sellPrice', label: 'B√°n', sortable: true }
                        ],
                        apiConfig: {
                            supabase: { url: '', headers: {} },
                            webgia: ''
                        }
                    };
                },
                methods: {
                    initApiConfig() {
                        const urlParams = new URLSearchParams(window.location.search);
                        this.apiConfig.supabase.url = urlParams.get('url');
                        const token = urlParams.get('header');
                        this.apiConfig.supabase.headers = {
                            'apikey': token,
                            'Authorization': `Bearer ${token}`
                        };
                        this.apiConfig.webgia = urlParams.get('webgia') ||
                            'https://cors.trinhminhbao.workers.dev/?url=https://webgia.com/gia-vang/mi-hong/';
                    },
                    async fetchInternalData() {
                        try {
                            const res = await fetch(this.apiConfig.supabase.url, {
                                headers: this.apiConfig.supabase.headers
                            });
                            if (!res.ok) throw new Error(`HTTP ${res.status}`);
                            const data = await res.json();
                            let processed = (data || []).map((item, index) => ({
                                ...item,
                                id: `internal-${index}`,
                                code: item.code === '9999' ? '995' : (item.code || item.age || null)
                            }));
                            const gold610 = processed.find(item => item.code === '610');
                            if (gold610) {
                                processed.push({
                                    id: 'internal-doi-610',
                                    code: '610',
                                    age: '610',
                                    hienthi: '610 ƒê·ªïi 100k',
                                    buyingPrice: (Number(gold610.sellingPrice) || 0) - 100,
                                    sellingPrice: (Number(gold610.sellingPrice) || 0) - 100
                                });
                            }
                            const gold710 = processed.find(item => item.code === '710');
                            if (gold710) {
                                processed.push({
                                    id: 'internal-doi-710',
                                    code: '710',
                                    age: '710',
                                    hienthi: '710 ƒê·ªïi 100k',
                                    buyingPrice: (Number(gold710.sellingPrice) || 0) - 100,
                                    sellingPrice: (Number(gold710.sellingPrice) || 0) - 100
                                });
                            }
                            const gold980 = processed.find(item => item.code === '980');
                            if (gold980) {
                                processed.push({
                                    id: 'internal-doi-980',
                                    code: '980',
                                    age: '980',
                                    hienthi: '980 ƒê·ªïi 100k',
                                    buyingPrice: (Number(gold980.sellingPrice) || 0) - 100,
                                    sellingPrice: (Number(gold980.sellingPrice) || 0) - 100
                                });
                            }
                            const getOrder = (item) => {
                                const key = item.hienthi || item.code;
                                if (key === '99') return 0;
                                if (key === '980') return 1;
                                if (key === '710') return 2;
                                if (key === '610') return 3;
                                if (key === '980 ƒê·ªïi 100k') return 4;
                                if (key === '610 ƒê·ªïi 100k') return 5;
                                if (key === '710 ƒê·ªïi 100k') return 6;
                                return Infinity;
                            };
                            processed.sort((a, b) => getOrder(a) - getOrder(b));
                            this.internalData = processed;
                            this.calculateDifferences();
                            return true;
                        } catch (e) {
                            console.error('L·ªói t·∫£i d·ªØ li·ªáu n·ªôi b·ªô:', e);
                            return false;
                        }
                    },
                    async fetchPublicData() {
                        try {
                            const res = await fetch(this.apiConfig.webgia);
                            const html = await res.text();
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(html, 'text/html');
                            const table = doc.querySelector('table.table-radius.table-hover');
                            if (!table) throw new Error('Kh√¥ng t√¨m th·∫•y b·∫£ng gi√°');
                            const rows = table.querySelectorAll('tbody tr');
                            const out = [];
                            rows.forEach(row => {
                                const nameCell = row.querySelector('th');
                                const cells = row.querySelectorAll('td');
                                if (!nameCell || cells.length < 2) return;
                                const name = nameCell.textContent.trim();
                                let buyPrice = 0, sellPrice = 0;
                                const buyCell = cells[0];
                                const buyText = buyCell.textContent.trim();
                                if (buyCell.hasAttribute('nb')) {
                                    buyPrice = window.GoldUtils.decodePrice(buyCell.getAttribute('nb'));
                                } else if (buyText !== '-') {
                                    const n = parseFloat(buyText.replace(/[^\d]/g, ''));
                                    if (!isNaN(n) && n > 0) buyPrice = n;
                                }
                                const sellCell = cells[1];
                                const sellText = sellCell.textContent.trim();
                                if (sellCell.hasAttribute('nb')) {
                                    sellPrice = window.GoldUtils.decodePrice(sellCell.getAttribute('nb'));
                                } else if (sellText !== '-') {
                                    const n = parseFloat(sellText.replace(/[^\d]/g, ''));
                                    if (!isNaN(n) && n > 0) sellPrice = n;
                                }
                                out.push({
                                    name,
                                    age: window.GoldUtils.extractAge(name),
                                    buyPrice,
                                    sellPrice
                                });
                            });
                            this.publicData = out;
                            const gold950 = out.find(x => Number(x.age) === 950 && Number(x.buyPrice) > 0);
                            if (gold950) {
                                this.gold950BuyPrice = gold950.buyPrice;
                            }
                            this.calculateDifferences();
                            this.calculateSuggestion610();
                            return true;
                        } catch (e) {
                            console.error('L·ªói t·∫£i d·ªØ li·ªáu c√¥ng khai:', e);
                            return false;
                        }
                    },
                    calculateSuggestion610() {
                        console.log('=== calculateSuggestion610 START ===');
                        console.log('gold950BuyPrice:', this.gold950BuyPrice);
                        console.log('publicData length:', this.publicData.length);

                        if (!this.gold950BuyPrice || !this.publicData.length) {
                            console.log('Early return: missing data');
                            return;
                        }

                        const gold610 = this.publicData.find(x => Number(x.age) === 610 && Number(x.buyPrice) > 0);
                        console.log('gold610 found:', gold610);

                        if (!gold610) {
                            console.log('Early return: no gold610');
                            return;
                        }

                        console.log('Calling PricingEngine with:', {
                            public610BuyPrice: gold610.buyPrice,
                            gold950BuyPrice: this.gold950BuyPrice
                        });

                        this.suggestion610V2 = window.PricingEngine.optimizeGold610PricesV2({
                            public610BuyPrice: gold610.buyPrice,
                            gold950BuyPrice: this.gold950BuyPrice,
                            recentGold950Prices: this.recentGold950Prices.length > 0 ? this.recentGold950Prices : null
                        });

                        console.log('PricingEngine result:', this.suggestion610V2);

                        if (this.suggestion610V2.optimal) {
                            // Calculate conversion details
                            const weight610 = 10; // 1 l∆∞·ª£ng = 10 ch·ªâ
                            const actualAge600 = 600; // V√†ng 610 th·ª±c t·∫ø ch·ªâ c√≥ 600
                            const LOSS_CONSTANT = 2; // H·∫±ng s·ªë hao h·ª•t

                            // C√¥ng th·ª©c ƒë·∫∑c bi·ªát: (600 - 20) * 9999 / 95 / 1000 = ch·ªâ 950 t·ª´ 1 l∆∞·ª£ng 610
                            const convertedWeight = ((actualAge600 - LOSS_CONSTANT) * 9999) / 95 / 10000;
                            const loss = weight610 - convertedWeight; // Hao h·ª•t
                            const costAt610 = weight610 * this.suggestion610V2.optimal.buyPrice;
                            const valueAt950 = convertedWeight * this.gold950BuyPrice;

                            console.log('Conversion calc:', {
                                weight610,
                                actualAge: 600,
                                convertedWeight: convertedWeight.toFixed(2),
                                loss: loss.toFixed(2),
                                costAt610,
                                valueAt950,
                                margin: valueAt950 - costAt610
                            });

                            this.suggestion610 = {
                                suggestedBuyPrice: this.suggestion610V2.optimal.buyPrice,
                                suggestedSellPrice: this.suggestion610V2.optimal.sellPrice,
                                spread: this.suggestion610V2.optimal.spread,
                                buyMargin: valueAt950 - costAt610, // D√πng margin t√≠nh ƒë√∫ng
                                profitPerLuong: this.suggestion610V2.optimal.spread * 10,
                                totalScore: this.suggestion610V2.optimal.totalScore.toFixed(2),
                                scoreBreakdown: this.suggestion610V2.optimal.scoreBreakdown,
                                safetyStatus: this.suggestion610V2.meta.safetyStatus,
                                actualAge: 600,
                                convertedWeight: convertedWeight.toFixed(2),
                                loss: loss.toFixed(2),
                                valueAt950: valueAt950,
                                costAt610: costAt610
                            };
                            console.log('suggestion610 set:', this.suggestion610);
                        } else {
                            console.log('No optimal solution found, using simple algorithm fallback');
                            // Fallback to simple algorithm
                            const simpleResult = window.GoldUtils.optimizeGold610Prices(
                                gold610.buyPrice,
                                this.gold950BuyPrice
                            );
                            console.log('Simple fallback result:', simpleResult);

                            if (simpleResult && simpleResult.suggestedBuyPrice) {
                                // Calculate conversion details for fallback
                                const weight610 = 10;
                                const actualAge610 = 610;
                                const targetAge950 = 950;
                                const convertedWeight = (weight610 * actualAge610) / targetAge950;
                                const costAt610 = weight610 * simpleResult.suggestedBuyPrice;
                                const valueAt950 = convertedWeight * this.gold950BuyPrice;

                                this.suggestion610 = {
                                    suggestedBuyPrice: simpleResult.suggestedBuyPrice,
                                    suggestedSellPrice: simpleResult.suggestedSellPrice,
                                    spread: simpleResult.spread,
                                    buyMargin: simpleResult.buyMargin,
                                    profitPerLuong: simpleResult.profitPerLuong,
                                    totalScore: '0',
                                    scoreBreakdown: {},
                                    safetyStatus: 'FALLBACK',
                                    convertedWeight: convertedWeight.toFixed(2),
                                    valueAt950: valueAt950,
                                    costAt610: costAt610
                                };
                                console.log('Using fallback suggestion610:', this.suggestion610);
                            }
                        }

                        this.recentGold950Prices.push(this.gold950BuyPrice);
                        if (this.recentGold950Prices.length > 20) {
                            this.recentGold950Prices.shift();
                        }

                        console.log('=== calculateSuggestion610 END ===');
                    },
                    calculateDifferences() {
                        if (!this.gold950BuyPrice || !this.internalData.length) return;
                        this.internalData = this.internalData.map(item => {
                            const actualAge = window.GoldUtils.getActualGoldAge(item.code || item.age || 610);
                            const originalWeight = 10;
                            const convertedWeight = window.GoldUtils.convertWeight(originalWeight, actualAge, 950);
                            const internalBuy = (Number(item.buyingPrice) || 0) * 1000;
                            const originalValue = originalWeight * internalBuy;
                            const convertedValue = convertedWeight * this.gold950BuyPrice;
                            const buyDiff = convertedValue - originalValue;
                            const buyPct = window.GoldUtils.calculatePercentageDiff(convertedValue, originalValue);
                            return {
                                ...item,
                                actualAge,
                                convertedWeight: convertedWeight.toFixed(2),
                                buyProfit: buyDiff,
                                buyDiffText: internalBuy > 0
                                    ? `${buyDiff >= 0 ? '+' : ''}${window.GoldUtils.formatMoney(Math.abs(buyDiff))} (${buyDiff >= 0 ? '+' : ''}${buyPct.toFixed(1)}%)`
                                    : '-'
                            };
                        });
                    },
                    async loadAllData() {
                        this.isLoading = true;
                        await Promise.all([
                            this.fetchInternalData(),
                            this.fetchPublicData()
                        ]);
                        this.isLoading = false;
                        this.lastUpdate = new Date().toLocaleString('vi-VN');
                    },
                    formatPrice(price) {
                        return window.GoldUtils.formatMoney((Number(price) || 0) * 1000);
                    },
                    formatPriceRaw(price) {
                        return window.GoldUtils.formatMoney(Number(price) || 0);
                    },
                    getDiffClass(profit) {
                        if (!profit) return '';
                        return profit >= 0 ? 'price-positive' : 'price-negative';
                    },
                    getMarginClass(margin) {
                        if (!margin) return '';
                        if (margin >= 3000000 && margin <= 5000000) return 'text-success font-weight-bold';
                        if (margin >= 2000000 && margin < 3000000) return 'text-warning';
                        return 'text-danger';
                    },
                    getSafetyVariant(status) {
                        if (status === 'SAFE') return 'success';
                        if (status === 'CAUTION') return 'warning';
                        return 'danger';
                    },
                    getSafetyAlertVariant(status) {
                        if (status === 'SAFE') return 'success';
                        if (status === 'CAUTION') return 'warning';
                        return 'danger';
                    },
                    getScoreClass(score) {
                        if (score >= 80) return 'text-success font-weight-bold';
                        if (score >= 60) return 'text-info';
                        if (score >= 40) return 'text-warning';
                        return 'text-danger';
                    },
                    formatScoreName(key) {
                        const names = {
                            profitTargetProximity: 'Profit Target',
                            competitiveness: 'Competitive',
                            spreadUtility: 'Spread',
                            volatilitySafety: 'Volatility',
                            maReversionSafety: 'MA Safety'
                        };
                        return names[key] || key;
                    }
                },
                mounted() {
                    this.initApiConfig();
                    this.loadAllData();
                    setInterval(() => {
                        this.loadAllData();
                    }, 5 * 60 * 1000);
                }
            });
        } // Close initVueApp function
    </script>
</body>

</html>